<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Video Player</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="all-wrapper">
        <div class="input-wrapper">
            <input type="text" id="videoPath" class="video-path" placeholder="Enter Video Path">
            <button id="loadVideo" class="load-video">Load Video</button>
            <button id="langToggle" class="lang-toggle">日本語</button>
        </div>

        <div class="video-wrapper">
            <div id="speedIndicator" class="speed-indicator">x2</div>
            <video id="videoElement" class="video-element" src="your_vide_path.mp4" controls></video>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('videoElement');
        const videoPathInput = document.getElementById('videoPath');
        const loadVideoBtn = document.getElementById('loadVideo');
        const speedIndicator = document.getElementById('speedIndicator');
        const langToggleBtn = document.getElementById('langToggle');

        let longPressTimer;
        let isEnglish = true;
        let wasPlaying = false;
        let isSpeedUp = false;

        const oneMonth = 30 * 24 * 60 * 60 * 1000; // One month in milliseconds | 1ヶ月をミリ秒

        // Encrypt function using CryptoJS
        function encrypt(data, key) {
            return CryptoJS.AES.encrypt(data, key).toString();
        }

        // Decrypt function using CryptoJS
        function decrypt(data, key) {
            const bytes = CryptoJS.AES.decrypt(data, key);
            return bytes.toString(CryptoJS.enc.Utf8);
        }

        // Save playback time to localStorage | 再生時間をlocalStorageに保存
        function savePlaybackTime() {
            const currentTime = videoElement.currentTime;
            const videoSrc = videoElement.src;
            const savedData = {
                time: currentTime,
                timestamp: Date.now()
            };
            localStorage.setItem(videoSrc, JSON.stringify(savedData));
        }

        // Load playback time from localStorage | localStorageから再生時間を読み込む
        function loadPlaybackTime() {
            const videoSrc = videoElement.src;
            const savedData = JSON.parse(localStorage.getItem(videoSrc));

            if (savedData && Date.now() - savedData.timestamp < oneMonth) {
                videoElement.currentTime = savedData.time;
            } else if (savedData) {
                localStorage.removeItem(videoSrc); // Remove outdated data
            } else {
                // item not found
                savePlaybackTime();
            }
        }

        // Cleanup playback times older than one month
        function cleanupPlaybackTimes() {
            const now = Date.now();
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const savedData = JSON.parse(localStorage.getItem(key));
                    if (savedData && now - savedData.timestamp >= oneMonth) {
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    // If there is an error parsing, just skip this item
                    console.log(`Error parsing data for key ${key}:`, e);
                }
            }
        }

        // Initial setup | 初期設定
        window.addEventListener('load', () => {
            loadPlaybackTime();
            // cleanupPlaybackTimes();
        });

        // Save playback time when the video is paused or ends | ビデオが一時停止または終了したときに再生時間を保存
        videoElement.addEventListener('pause', savePlaybackTime);
        videoElement.addEventListener('ended', savePlaybackTime);

        // Press and hold to double speed | 長押しで2倍速 
        videoElement.addEventListener('mousedown', () => {
            wasPlaying = !videoElement.paused; // Save the current playback state | 現在の再生状態を保存

            longPressTimer = setTimeout(() => {
                isSpeedUp = true;
                videoElement.playbackRate = 2.0;
                speedIndicator.style.visibility = 'visible'; // Show x2 | x2を表示
            }, 500); // Long press time (500ms) | 長押し時間（500ms）
        });

        videoElement.addEventListener('mouseup', () => {
            clearTimeout(longPressTimer);
            videoElement.playbackRate = 1.0; // Return to normal speed | 通常の速度に戻す
            speedIndicator.style.visibility = 'hidden'; // Hide x2 | x2を非表示

            if (wasPlaying && isSpeedUp) {
                isSpeedUp = false;
                setTimeout(() => {
                    wasPlaying = !videoElement.paused;
                    videoElement.play(); // Continue playing if it was playing before | 以前に再生していた場合は再生を続ける
                }, 0);
            }
        });

        // Keyboard Controls | キーボードコントロール
        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'ArrowRight':
                    videoElement.currentTime += 5;
                    break;
                case 'ArrowLeft':
                    videoElement.currentTime -= 5;
                    break;
                case ' ':
                    event.preventDefault();
                    if (videoElement.paused) {
                        videoElement.play();
                    } else {
                        videoElement.pause();
                    }
                    break;
            }
        });

        // Ability to set video path and load | ビデオのパスを設定して読み込む機能
        loadVideoBtn.addEventListener('click', () => {
            let path = videoPathInput.value;
            path = path.replace(/['"]/g, ''); // Remove " and ' | "や'を取り除く
            if (path) {
                videoElement.src = path;
                videoElement.load();
                videoElement.play();
                loadPlaybackTime();
            }
        });

        // Language Toggle | 言語切り替え
        langToggleBtn.addEventListener('click', () => {
            isEnglish = !isEnglish;
            updateLanguage();
        });

        // Update language | 言語を更新
        function updateLanguage() {
            if (isEnglish) {
                videoPathInput.placeholder = 'Enter video path';
                loadVideoBtn.textContent = 'Load Video';
                langToggleBtn.textContent = '日本語';
                document.title = 'Custom Video Player';
            } else {
                videoPathInput.placeholder = 'ビデオのパスを入力';
                loadVideoBtn.textContent = 'ビデオを読み込む';
                langToggleBtn.textContent = 'English';
                document.title = 'カスタムビデオプレーヤー';
            }
        }
    </script>

</body>

</html>